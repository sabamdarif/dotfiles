#!/bin/bash

# Theme Changer Menu
WAYBAR_CONFIG_DIR="$HOME/.config/waybar"
WAYBAR_THEMES_DIR="$HOME/.config/waybar/themes"
ROFI_CONFIG_DIR="$HOME/.config/rofi"
ROFI_THEMES_DIR="$HOME/.config/rofi/themes"
SWAYNC_CONFIG_DIR="$HOME/.config/swaync"
SWAYNC_THEMES_DIR="$HOME/.config/swaync/themes"

menu() {
    local prompt="$1"
    local options="$2"
    local extra="$3"
    local preselect="$4"

    read -r -a args <<<"$extra"

    if [[ -n "$preselect" ]]; then
        local index
        index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
        if [[ -n "$index" ]]; then
            args+=("-c" "$index")
        fi
    fi

    echo -e "$options" | rofi -dmenu -p "$prompt" -theme ~/.config/rofi/settings-menu.rasi "${args[@]}" 2>/dev/null
}

notify() {
    notify-send "$1" "$2"
}

is_running() {
    pgrep -x "$1" >/dev/null 2>&1
}

# ============================================================================
# Dark/Light Theme Functions
# ============================================================================

toggle_dark_light_theme() {
    local mode="$1"

    if [[ -x "$HOME/.config/swaync/scripts/toggle_dark_mode.sh" ]]; then
        "$HOME/.config/swaync/scripts/toggle_dark_mode.sh" "$mode"
        notify "Theme Applied" "$(echo "$mode" | sed 's/./\U&/') theme activated"
    else
        notify "Error" "Dark mode script not found"
    fi
}

show_dark_light_menu() {
    local themes="󰖔  Dark Theme\n󰖨  Light Theme"
    local selected=$(menu "󰔎  Select Color Scheme" "$themes")

    case "$selected" in
    *"Dark Theme"*) toggle_dark_light_theme "dark" ;;
    *"Light Theme"*) toggle_dark_light_theme "light" ;;
    esac
}

# ============================================================================
# Waybar Theme Functions
# ============================================================================

list_waybar_themes() {
    # List all available waybar themes
    if [[ ! -d "$WAYBAR_THEMES_DIR" ]]; then
        echo ""
        return 1
    fi

    find "$WAYBAR_THEMES_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort
}

apply_waybar_theme() {
    local theme_name="$1"
    local theme_dir="$WAYBAR_THEMES_DIR/$theme_name"

    if [[ ! -d "$theme_dir" ]]; then
        notify "Error" "Theme directory not found: $theme_name"
        return 1
    fi

    notify "Applying Waybar Theme" "Setting up $theme_name..."

    # Remove old config files
    rm -f "$WAYBAR_CONFIG_DIR/config.jsonc" \
        "$WAYBAR_CONFIG_DIR/config" \
        "$WAYBAR_CONFIG_DIR/style.css"

    # Copy new theme files
    local files_copied=0

    if [[ -f "$theme_dir/config.jsonc" ]]; then
        cp "$theme_dir/config.jsonc" "$WAYBAR_CONFIG_DIR/config.jsonc"
        ((files_copied++))
    fi

    if [[ -f "$theme_dir/config" ]]; then
        cp "$theme_dir/config" "$WAYBAR_CONFIG_DIR/config"
        ((files_copied++))
    fi

    if [[ -f "$theme_dir/style.css" ]]; then
        cp "$theme_dir/style.css" "$WAYBAR_CONFIG_DIR/style.css"
        ((files_copied++))
    fi

    if [[ $files_copied -eq 0 ]]; then
        notify "Error" "No valid config files found in theme: $theme_name"
        return 1
    fi

    # Reload waybar
    # killall -SIGUSR2 waybar 2>/dev/null # didn't use it as it sometime leave some old theme artifact on the waybar
    pkill waybar
    waybar &
    disown
    notify "Waybar Theme Applied" "$theme_name is now active!"
}

show_waybar_theme_menu() {
    local theme_list=$(list_waybar_themes)

    if [[ -z "$theme_list" ]]; then
        notify "No Themes Found" "Create themes in $WAYBAR_THEMES_DIR"
        return 1
    fi

    local selected_theme=$(menu "󰸌  Select Waybar Theme" "$theme_list")

    if [[ "$selected_theme" != "CNCLD" && -n "$selected_theme" ]]; then
        apply_waybar_theme "$selected_theme"
    fi
}

# ============================================================================
# Rofi Theme Functions
# ============================================================================

list_rofi_menu_types() {
    # List all menu types (folders in themes directory, excluding non-menu folders)
    if [[ ! -d "$ROFI_THEMES_DIR" ]]; then
        echo ""
        return 1
    fi

    find "$ROFI_THEMES_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; |
        grep -v -E "^(colors|fonts|icons)$" | sort
}

list_rofi_themes_for_menu() {
    local menu_type="$1"
    local menu_themes_dir="$ROFI_THEMES_DIR/$menu_type"

    if [[ ! -d "$menu_themes_dir" ]]; then
        echo ""
        return 1
    fi

    find "$menu_themes_dir" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort
}

apply_rofi_theme() {
    local menu_type="$1"
    local theme_name="$2"
    local theme_file="$ROFI_THEMES_DIR/$menu_type/$theme_name/${menu_type}.rasi"
    local target_file="$ROFI_CONFIG_DIR/${menu_type}.rasi"

    if [[ ! -f "$theme_file" ]]; then
        notify "Error" "Theme file not found: $theme_name/${menu_type}.rasi"
        return 1
    fi

    # Backup existing file if it exists
    if [[ -f "$target_file" ]]; then
        cp "$target_file" "${target_file}.bak"
    fi

    # Copy theme file to config directory
    cp "$theme_file" "$target_file"

    notify "Rofi Theme Applied" "$theme_name applied to $menu_type!"
}

show_rofi_theme_list() {
    local menu_type="$1"
    local theme_list=$(list_rofi_themes_for_menu "$menu_type")

    if [[ -z "$theme_list" ]]; then
        notify "No Themes Found" "No themes available for $menu_type"
        return 1
    fi

    local selected_theme=$(menu "󰰠  Select Theme for $menu_type" "$theme_list")

    if [[ "$selected_theme" != "CNCLD" && -n "$selected_theme" ]]; then
        apply_rofi_theme "$menu_type" "$selected_theme"
    fi
}

show_rofi_theme_menu() {
    local menu_types=$(list_rofi_menu_types)

    if [[ -z "$menu_types" ]]; then
        notify "No Menu Types Found" "Create menu type folders in $ROFI_THEMES_DIR"
        return 1
    fi

    # Format menu types with icons
    local formatted_menu=""
    while IFS= read -r menu_type; do
        case "$menu_type" in
        "app-menu") formatted_menu+="󰀻  App Menu\n" ;;
        "clipboard-monitor") formatted_menu+="󰅇  Clipboard Monitor\n" ;;
        "emoji-selector" | "rofimoji-grid") formatted_menu+="󰞅  Emoji Picker\n" ;;
        "wallpaper-selector") formatted_menu+="󰸉  Wallpaper Selector\n" ;;
        "settings-menu") formatted_menu+="󰒓  Settings Menu\n" ;;
        "wifi-menu") formatted_menu+="󰖩  WiFi Menu\n" ;;
        *) formatted_menu+="󰍉  $(echo "$menu_type" | sed 's/-/ /g; s/\b\(.\)/\u\1/g')\n" ;;
        esac
    done <<<"$menu_types"

    # Remove trailing newline
    formatted_menu="${formatted_menu%\\n}"

    local selected=$(menu "󰰠  Select Menu Type" "$formatted_menu")

    if [[ "$selected" == "CNCLD" || -z "$selected" ]]; then
        return 0
    fi

    # Extract the actual menu type from the selection
    local actual_menu_type=""
    case "$selected" in
    *"App Menu"*) actual_menu_type="app-menu" ;;
    *"Clipboard Monitor"*) actual_menu_type="clipboard-monitor" ;;
    *"Emoji Picker"*)
        # Check which one exists
        if [[ -d "$ROFI_THEMES_DIR/emoji-selector" ]]; then
            actual_menu_type="emoji-selector"
        elif [[ -d "$ROFI_THEMES_DIR/rofimoji-grid" ]]; then
            actual_menu_type="rofimoji-grid"
        fi
        ;;
    *"Wallpaper Selector"*) actual_menu_type="wallpaper-selector" ;;
    *"Settings Menu"*) actual_menu_type="settings-menu" ;;
    *"WiFi Menu"*) actual_menu_type="wifi-menu" ;;
    *)
        # Try to extract from formatted name
        actual_menu_type=$(echo "$selected" | sed 's/^[^ ]* *//' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
        ;;
    esac

    if [[ -n "$actual_menu_type" ]]; then
        show_rofi_theme_list "$actual_menu_type"
    fi
}

# ============================================================================
# SwayNC Theme Functions
# ============================================================================

list_swaync_themes() {
    # List all available SwayNC themes
    if [[ ! -d "$SWAYNC_THEMES_DIR" ]]; then
        echo ""
        return 1
    fi

    find "$SWAYNC_THEMES_DIR" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort
}

apply_swaync_theme() {
    local theme_name="$1"
    local theme_dir="$SWAYNC_THEMES_DIR/$theme_name"

    if [[ ! -d "$theme_dir" ]]; then
        notify "Error" "Theme directory not found: $theme_name"
        return 1
    fi

    notify "Applying SwayNC Theme" "Setting up $theme_name..."

    # Remove old config files
    rm -f "$SWAYNC_CONFIG_DIR/style.css" \
        "$SWAYNC_CONFIG_DIR/config.json"

    # Copy new theme files
    local files_copied=0

    if [[ -f "$theme_dir/config.json" ]]; then
        cp "$theme_dir/config.json" "$SWAYNC_CONFIG_DIR/config.json"
        ((files_copied++))
    fi

    if [[ -f "$theme_dir/style.css" ]]; then
        cp "$theme_dir/style.css" "$SWAYNC_CONFIG_DIR/style.css"
        ((files_copied++))
    fi

    if [[ $files_copied -eq 0 ]]; then
        notify "Error" "No valid config files found in theme: $theme_name"
        return 1
    fi

    # Reload or start SwayNC
    if is_running "swaync"; then
        echo "Restarting SwayNC..."
        swaync-client -R
        swaync-client -rs
    else
        echo "Starting SwayNC..."
        swaync &
        disown
    fi

    notify "SwayNC Theme Applied" "$theme_name is now active!"
}

show_swaync_theme_menu() {
    local theme_list=$(list_swaync_themes)

    if [[ -z "$theme_list" ]]; then
        notify "No Themes Found" "Create themes in $SWAYNC_THEMES_DIR"
        return 1
    fi

    local selected_theme=$(menu "󰂚  Select SwayNC Theme" "$theme_list")

    if [[ "$selected_theme" != "CNCLD" && -n "$selected_theme" ]]; then
        apply_swaync_theme "$selected_theme"
    fi
}

# ============================================================================
# Main Theme Menu
# ============================================================================

show_theme_menu() {
    local selection=$(menu "󰸌  Theme Settings" "󰔎  Color Scheme (Dark/Light)\n󱔓  Waybar Theme\n󰰠  Rofi Theme\n󰂚  SwayNC Theme")

    case "$selection" in
    *"Color Scheme"*) show_dark_light_menu ;;
    *"Waybar Theme"*) show_waybar_theme_menu ;;
    *"Rofi Theme"*) show_rofi_theme_menu ;;
    *"SwayNC Theme"*) show_swaync_theme_menu ;;
    *) exit 0 ;;
    esac
}

# ============================================================================
# Entry Point
# ============================================================================

# Run the theme menu
show_theme_menu
