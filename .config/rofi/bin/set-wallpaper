#!/usr/bin/env bash

# Configuration
WALLPAPER_PATH="$HOME/.config/background"
BLURRED_WALLPAPER_PATH="$HOME/.config/blurred-background"
LOG_FILE="$HOME/.config/rofi/rofi-wallpaper.log"
MODE=$(cat "$HOME/.config/matugen/current_mode" 2>/dev/null || echo "dark")
WALLPAPER_DIR="$HOME/Pictures/wallpapers/"
THEME_FILE="$HOME/.config/rofi/wallpaper-selector.rasi"

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

# Function to log messages
echo "" >"$LOG_FILE"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >>"$LOG_FILE"
}

log "=== Script started ==="

# Function to set wallpaper and generate colors
setwall() {
    local wallpaper="$1"
    log "setwall() called with: $wallpaper"

    # Check if the provided file exists
    if [[ ! -f "$wallpaper" ]]; then
        log "ERROR: File '$wallpaper' does not exist"
        echo "Error: File '$wallpaper' does not exist"
        return 1
    fi
    log "File exists, proceeding..."

    # Check if matugen is installed
    if [ ! -f "$HOME/.cargo/bin/matugen" ]; then
        log "ERROR: 'matugen' is not installed"
        echo "Error: 'matugen' is not installed"
        return 1
    fi
    log "matugen found"

    # Check if ImageMagick is installed
    if ! command -v magick >/dev/null 2>&1; then
        log "ERROR: 'magick' (ImageMagick) is not installed"
        echo "Error: 'magick' (ImageMagick) is not installed"
        return 1
    fi
    log "ImageMagick found"

    # Delete old wallpapers if they exist
    [[ -f "$WALLPAPER_PATH" ]] && rm -f "$WALLPAPER_PATH"
    [[ -f "$BLURRED_WALLPAPER_PATH" ]] && rm -f "$BLURRED_WALLPAPER_PATH"
    log "Old wallpapers removed (if existed)"

    # Copy new wallpaper
    if ! cp "$wallpaper" "$WALLPAPER_PATH"; then
        log "ERROR: Failed to copy wallpaper"
        echo "Error: Failed to copy wallpaper"
        return 1
    fi
    log "New wallpaper copied successfully"

    # Set wallpaper with swaybg or swww (choose one)
    if command -v swww >/dev/null 2>&1; then
        log "Using swww to set wallpaper"
        swww img "$WALLPAPER_PATH" --resize fit --transition-type center --transition-duration 2 2>&1 | tee -a "$LOG_FILE"
    elif command -v swaybg >/dev/null 2>&1; then
        log "Using swaybg to set wallpaper"
        pkill swaybg
        swaybg -i "$WALLPAPER_PATH" -m fill &
    else
        log "ERROR: Neither swww nor swaybg found"
    fi

    # Create blurred version
    log "Creating blurred wallpaper..."
    if ! magick "$WALLPAPER_PATH" -blur 0x8 "$BLURRED_WALLPAPER_PATH" 2>&1 | tee -a "$LOG_FILE"; then
        log "ERROR: Failed to create blurred wallpaper"
        echo "Error: Failed to create blurred wallpaper"
        return 1
    fi
    log "Blurred wallpaper created successfully"

    # Set blurred wallpaper with swaybg on a different output (if needed)
    # Or you can use it as a lockscreen background, etc.
    log "Setting blurred wallpaper with swaybg..."
    if command -v swaybg >/dev/null 2>&1; then
        # Kill existing swaybg processes for blurred wallpaper
        pkill -f "swaybg.*$BLURRED_WALLPAPER_PATH"
        # Start swaybg with blurred wallpaper
        swaybg -i "$BLURRED_WALLPAPER_PATH" -m fill &
        log "Blurred wallpaper set with swaybg"
    else
        log "WARNING: swaybg not found, blurred wallpaper created but not applied"
    fi

    # Generate color palettes with matugen
    log "Running matugen..."
    ~/.cargo/bin/matugen image --mode "$MODE" "$WALLPAPER_PATH" 2>&1 | tee -a "$LOG_FILE"
    log "matugen completed"

    # reload all services (removed exec to allow script to continue)
    log "Reloading all services..."
    if [[ -f "$HOME/.local/bin/reload_all" ]]; then
        ~/.local/bin/reload_all 2>&1 | tee -a "$LOG_FILE"
        log "reload_all completed"
    else
        log "WARNING: reload_all script not found"
    fi

    log "setwall() finished successfully"
}

# If script is called directly with an argument, apply that wallpaper
if [[ -n "$1" ]]; then
    log "Direct call with argument: $1"

    # Expand tilde in path if present
    WALLPAPER_ARG="${1/#\~/$HOME}"

    log "Expanded path: $WALLPAPER_ARG"

    # Apply the wallpaper
    setwall "$WALLPAPER_ARG"
    exit_code=$?

    # Send notification if successful
    if [[ $exit_code -eq 0 ]]; then
        if command -v notify-send >/dev/null 2>&1; then
            notify-send "Wallpaper Changed" "Set to: $(basename "$WALLPAPER_ARG")" -i "$WALLPAPER_PATH"
            log "Notification sent"
        fi
        echo "Wallpaper applied successfully!"
    fi

    exit $exit_code
fi

# If no argument provided, show rofi UI
# Rofi Wallpaper Selector with Direct Image Preview
log "Starting rofi wallpaper selector"
log "WALLPAPER_DIR: $WALLPAPER_DIR"
log "THEME_FILE: $THEME_FILE"

# Function to display wallpapers in rofi
show_wallpapers() {
    log "show_wallpapers() called"

    # Create temp file for the options
    local options_file
    options_file=$(mktemp)
    log "Created temp file: $options_file"

    # Get all image files and add them to options with their path as icon
    local count=0
    while IFS= read -r file; do
        local name
        name=$(basename "$file" | sed 's/\.[^.]*$//')
        echo -e "$name\0icon\x1f$file" >>"$options_file"
        ((count++))
    done < <(find "$WALLPAPER_DIR" -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.gif" -o -name "*.bmp" -o -name "*.tiff" \) | sort)

    log "Found $count wallpaper files"

    # Show rofi with custom theme
    log "Launching rofi..."
    local selected
    selected=$(rofi -dmenu -i \
        -theme "$THEME_FILE" <"$options_file")
    local rofi_exit=$?
    log "rofi exited with code: $rofi_exit"
    log "Selected: '$selected'"

    # Remove temp file
    rm "$options_file"
    log "Removed temp file"

    # Handle selection
    if [ $rofi_exit -eq 0 ] && [ -n "$selected" ]; then
        log "Processing selection: $selected"
        # Find the full path of the selected wallpaper
        local selected_wallpaper=""
        while IFS= read -r file; do
            if [[ "$(basename "$file" | sed 's/\.[^.]*$//')" = "$selected" ]]; then
                selected_wallpaper="$file"
                log "Found matching file: $selected_wallpaper"
                break
            fi
        done < <(find "$WALLPAPER_DIR" -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.gif" -o -name "*.bmp" -o -name "*.tiff" \))

        if [ -n "$selected_wallpaper" ]; then
            log "Calling setwall with: $selected_wallpaper"
            setwall "$selected_wallpaper"
            log "Sending notification..."
            notify-send "Wallpaper Changed" "Set to: $selected" -i "$selected_wallpaper"
            log "Notification sent"
        else
            log "ERROR: Could not find full path for selected wallpaper"
        fi
    else
        log "No selection made or rofi cancelled"
    fi
}

# Main
log "Calling show_wallpapers()"
show_wallpapers
log "=== Script ended ==="
