#!/usr/bin/env bash

# Configuration
BLURRED_WALLPAPER_PATH="$HOME/.config/blurred-background"
LOG_FILE="$HOME/.config/rofi/rofi-wallpaper.log"
MODE=$(cat "$HOME/.config/matugen/current_mode" 2>/dev/null || echo "dark")
WALLPAPER_DIR="$HOME/Pictures/wallpapers/"
THEME_FILE="$HOME/.config/rofi/wallpaper-selector.rasi"

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

# Function to log messages
echo "" >"$LOG_FILE"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >>"$LOG_FILE"
}

log "=== Script started ==="

# Function to check if file is a GIF
is_gif() {
    local file="$1"
    [[ "${file,,}" == *.gif ]]
}

# Function to set wallpaper and generate colors
setwall() {
    local wallpaper="$1"
    log "setwall() called with: $wallpaper"

    # Check if the provided file exists
    if [[ ! -f "$wallpaper" ]]; then
        log "ERROR: File '$wallpaper' does not exist"
        echo "Error: File '$wallpaper' does not exist"
        return 1
    fi
    log "File exists, proceeding..."

    # Check if matugen is installed
    if [ ! -f "$HOME/.local/bin/matugen" ]; then
        log "ERROR: 'matugen' is not installed"
        echo "Error: 'matugen' is not installed"
        return 1
    fi
    log "matugen found"

    # Check if ImageMagick is installed
    if ! command -v magick >/dev/null 2>&1; then
        log "ERROR: 'magick' (ImageMagick) is not installed"
        echo "Error: 'magick' (ImageMagick) is not installed"
        return 1
    fi
    log "ImageMagick found"

    # Set WALLPAPER_PATH based on file type
    local WALLPAPER_PATH
    if is_gif "$wallpaper"; then
        WALLPAPER_PATH="$HOME/.config/background.gif"
        log "Detected GIF, using path: $WALLPAPER_PATH"
    else
        WALLPAPER_PATH="$HOME/.config/background"
        log "Using standard path: $WALLPAPER_PATH"
    fi

    # Delete old wallpapers if they exist (both possible paths)
    [[ -f "$HOME/.config/background" ]] && rm -f "$HOME/.config/background"
    [[ -f "$HOME/.config/background.gif" ]] && rm -f "$HOME/.config/background.gif"
    [[ -f "$BLURRED_WALLPAPER_PATH" ]] && rm -f "$BLURRED_WALLPAPER_PATH"
    log "Old wallpapers removed (if existed)"

    # Copy new wallpaper
    if ! cp "$wallpaper" "$WALLPAPER_PATH"; then
        log "ERROR: Failed to copy wallpaper"
        echo "Error: Failed to copy wallpaper"
        return 1
    fi
    log "New wallpaper copied successfully to $WALLPAPER_PATH"

    # Set wallpaper with swww or swaybg
    if command -v swww >/dev/null 2>&1; then
        log "Using swww to set wallpaper"
        if is_gif "$wallpaper"; then
            log "Setting animated GIF with swww"
        fi
        swww img "$WALLPAPER_PATH" --transition-type center --transition-duration 2 2>&1 | tee -a "$LOG_FILE"
    elif command -v swaybg >/dev/null 2>&1; then
        log "Using swaybg to set wallpaper"
        if is_gif "$wallpaper"; then
            log "WARNING: swaybg does not support animated GIFs. Converting first frame to static image..."
            # Convert GIF to static PNG for swaybg
            local static_wallpaper="${WALLPAPER_PATH}.png"
            magick "${WALLPAPER_PATH}[0]" "$static_wallpaper" 2>&1 | tee -a "$LOG_FILE"
            pkill swaybg
            swaybg -i "$static_wallpaper" -m fill &
        else
            pkill swaybg
            swaybg -i "$WALLPAPER_PATH" -m fill &
        fi
    else
        log "ERROR: Neither swww nor swaybg found"
    fi

    # Create blurred version
    log "Creating blurred wallpaper..."
    if is_gif "$wallpaper"; then
        log "Extracting first frame from GIF..."
        # First extract a static image from the GIF
        local extracted_frame="${WALLPAPER_PATH}.extracted.png"
        if ! magick "${WALLPAPER_PATH}[0]" "$extracted_frame" 2>&1 | tee -a "$LOG_FILE"; then
            log "ERROR: Failed to extract frame from GIF"
            echo "Error: Failed to extract frame from GIF"
            return 1
        fi
        log "Frame extracted successfully: $extracted_frame"

        # Now blur the extracted static image
        log "Blurring extracted frame..."
        if ! magick "$extracted_frame" -blur 0x8 "$BLURRED_WALLPAPER_PATH" 2>&1 | tee -a "$LOG_FILE"; then
            log "ERROR: Failed to create blurred wallpaper"
            echo "Error: Failed to create blurred wallpaper"
            rm -f "$extracted_frame"
            return 1
        fi
        log "Blurred wallpaper created successfully from extracted frame"

        # Clean up the temporary extracted frame
        rm -f "$extracted_frame"
        log "Cleaned up temporary extracted frame"
    else
        if ! magick "$WALLPAPER_PATH" -blur 0x8 "$BLURRED_WALLPAPER_PATH" 2>&1 | tee -a "$LOG_FILE"; then
            log "ERROR: Failed to create blurred wallpaper"
            echo "Error: Failed to create blurred wallpaper"
            return 1
        fi
        log "Blurred wallpaper created successfully"
    fi

    # Set blurred wallpaper with swaybg on a different output (if needed)
    # Or you can use it as a lockscreen background, etc.
    log "Setting blurred wallpaper with swaybg..."
    if command -v swaybg >/dev/null 2>&1; then
        # Kill existing swaybg processes for blurred wallpaper
        pkill -f "swaybg.*$BLURRED_WALLPAPER_PATH"
        # Start swaybg with blurred wallpaper
        swaybg -i "$BLURRED_WALLPAPER_PATH" -m fill &
        log "Blurred wallpaper set with swaybg"
    else
        log "WARNING: swaybg not found, blurred wallpaper created but not applied"
    fi

    # Generate color palettes with matugen
    log "Running matugen..."
    if is_gif "$wallpaper"; then
        log "Extracting first frame of GIF for color palette generation"
        # Create temporary static version for matugen
        local temp_for_matugen="${WALLPAPER_PATH}.matugen.png"
        magick "${WALLPAPER_PATH}[0]" "$temp_for_matugen" 2>&1 | tee -a "$LOG_FILE"
        ~/.local/bin/matugen image --mode "$MODE" "$temp_for_matugen" 2>&1 | tee -a "$LOG_FILE"
        rm -f "$temp_for_matugen"
    else
        ~/.local/bin/matugen image --mode "$MODE" "$WALLPAPER_PATH" 2>&1 | tee -a "$LOG_FILE"
    fi
    log "matugen completed"

    # reload all services (removed exec to allow script to continue)
    log "Reloading all services..."
    if [[ -f "$HOME/.local/bin/reload_all" ]]; then
        ~/.local/bin/reload_all 2>&1 | tee -a "$LOG_FILE"
        log "reload_all completed"
    else
        log "WARNING: reload_all script not found"
    fi

    log "setwall() finished successfully"
}

# If script is called directly with an argument, apply that wallpaper
if [[ -n "$1" ]]; then
    log "Direct call with argument: $1"

    # Expand tilde in path if present
    WALLPAPER_ARG="${1/#\~/$HOME}"

    log "Expanded path: $WALLPAPER_ARG"

    # Apply the wallpaper
    setwall "$WALLPAPER_ARG"
    exit_code=$?

    # Send notification if successful
    if [[ $exit_code -eq 0 ]]; then
        if command -v notify-send >/dev/null 2>&1; then
            # Determine WALLPAPER_PATH for notification icon
            if is_gif "$WALLPAPER_ARG"; then
                WALLPAPER_PATH="$HOME/.config/background.gif"
                wallpaper_type="Animated Wallpaper (GIF)"
            else
                WALLPAPER_PATH="$HOME/.config/background"
                wallpaper_type="Wallpaper"
            fi
            notify-send "$wallpaper_type Changed" "Set to: $(basename "$WALLPAPER_ARG")" -i "$WALLPAPER_PATH"
            log "Notification sent"
        fi
        echo "Wallpaper applied successfully!"
    fi

    exit $exit_code
fi

# If no argument provided, show rofi UI
# Rofi Wallpaper Selector with Direct Image Preview
log "Starting rofi wallpaper selector"
log "WALLPAPER_DIR: $WALLPAPER_DIR"
log "THEME_FILE: $THEME_FILE"

# Function to display wallpapers in rofi
show_wallpapers() {
    log "show_wallpapers() called"

    # Create temp file for the options
    local options_file
    options_file=$(mktemp)
    log "Created temp file: $options_file"

    # Get all image files and add them to options with their path as icon
    local count=0
    while IFS= read -r file; do
        local name
        name=$(basename "$file" | sed 's/\.[^.]*$//')
        # Add [GIF] prefix for animated wallpapers
        if is_gif "$file"; then
            name="ðŸŽ¬ $name"
        fi
        echo -e "$name\0icon\x1f$file" >>"$options_file"
        ((count++))
    done < <(find "$WALLPAPER_DIR" -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.gif" -o -name "*.bmp" -o -name "*.tiff" \) | sort)

    log "Found $count wallpaper files"

    # Show rofi with custom theme
    log "Launching rofi..."
    local selected
    selected=$(rofi -dmenu -i \
        -theme "$THEME_FILE" <"$options_file")
    local rofi_exit=$?
    log "rofi exited with code: $rofi_exit"
    log "Selected: '$selected'"

    # Remove temp file
    rm "$options_file"
    log "Removed temp file"

    # Handle selection
    if [ $rofi_exit -eq 0 ] && [ -n "$selected" ]; then
        log "Processing selection: $selected"
        # Remove the GIF prefix if present
        selected="${selected#ðŸŽ¬ }"

        # Find the full path of the selected wallpaper
        local selected_wallpaper=""
        while IFS= read -r file; do
            if [[ "$(basename "$file" | sed 's/\.[^.]*$//')" = "$selected" ]]; then
                selected_wallpaper="$file"
                log "Found matching file: $selected_wallpaper"
                break
            fi
        done < <(find "$WALLPAPER_DIR" -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.gif" -o -name "*.bmp" -o -name "*.tiff" \))

        if [ -n "$selected_wallpaper" ]; then
            log "Calling setwall with: $selected_wallpaper"
            setwall "$selected_wallpaper"
            log "Sending notification..."
            local wallpaper_type="Wallpaper"
            if is_gif "$selected_wallpaper"; then
                wallpaper_type="Animated Wallpaper (GIF)"
            fi
            notify-send "$wallpaper_type Changed" "Set to: $selected" -i "$selected_wallpaper"
            log "Notification sent"
        else
            log "ERROR: Could not find full path for selected wallpaper"
        fi
    else
        log "No selection made or rofi cancelled"
    fi
}

# Main
log "Calling show_wallpapers()"
show_wallpapers
log "=== Script ended ==="
